<script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/handsontable/0.28.4/handsontable.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/locale/ja.js"></script>
<link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/handsontable/0.28.4/handsontable.full.min.css">

<!-- 年月日設定 -->
<input type="text" id="year" size="4"/>年
<select id="month">
    <option value="0">1月</option>
    <option value="1">2月</option>
    <option value="2">3月</option>
    <option value="3">4月</option>
    <option value="4">5月</option>
    <option value="5">6月</option>
    <option value="6">7月</option>
    <option value="7">8月</option>
    <option value="8">9月</option>
    <option value="9">10月</option>
    <option value="10">11月</option>
    <option value="11">12月</option>
</select>

<!-- グリッド表示 -->
<div id="grid" ></div>

<!-- マークダウン表示 -->
<div id="platform_result" style="border:1px #ccc solid;" class="copy"></div>

<script>
  var data = init_data();

  // データ初期化
  function init_data() {
    var
      m = moment().startOf('month'),
      end_date = m.daysInMonth();

    return create_data(m, end_date);
  }

  // Data作成
  function create_data(m, end_date) {
    var
      i = 0,
      data_list = [];

    for ( ; i < end_date; i++ ) {
      d = [];
      d.push(m.format('MM/DD (ddd)'));
      m.add(1, 'day');
      data_list.push(d);
    }

    return data_list;
  }

  // 年月が変更された時にグリッドを変更する
  function change_date() {
    var
      m = moment(),
      data  = create_data(m.startOf('month'), m.startOf('month').daysInMonth());
    grid.loadData( data );
  }

  var platform_editor = {};
  ( function() {

    "use strict";

    var platform_result = document.getElementById( 'platform_result' );

    // プラットフォームのjQuery実行内容出力結果
    platform_editor.setText = function() {

      var result = '';

      $.each( data, function( i , value ) {

        if ( i == 1 ) {

          result += new Array( value.length + 1 ).join( ' --- | ' );
          result =  result.substr( 0, result.length - 2 ) + '<br>';

        }

        result += value.join( ' | ' );
        result =  result.substr( 0, result.length ) + '<br>';

      });

      platform_result.innerHTML = result;
    };

    // コピペを簡単にする
    $( '#markdown' ).click( function() {

      var
        range = document.createRange(),
        selection = window.getSelection();

      range.selectNodeContents( this );
      selection.removeAllRanges();
      selection.addRange( range );

    });

  })();

  var grid = {};
  ( function() {

    "use strict";

    var
      container = document.getElementById( 'grid' ),

      addRowBtn = document.getElementById( 'add_row_btn' ),

      delRowBtn = document.getElementById( 'del_row_btn' ),

      addColBtn = document.getElementById( 'add_col_btn' ),

      delColBtn = document.getElementById( 'del_col_btn' ),

      time_list = function () {
        var
          m = moment().startOf('day'),
          i = 0,
          end_time_count = 96,
          add_minute = 15,
          list = [];

        for ( ; i < end_time_count; i++ ) {
          list.push( m.format('HH:mm') );
          m.add(add_minute, 'minute');
        }

        return list;
      };

    // マイナスイメージのセルの表示設定
    function negativeValueRenderer( instance, td, row, col, prop, value, cellProperties ) {

      Handsontable.renderers.TextRenderer.apply( this, arguments );

      if ( parseInt( value, 10 ) < 0 ) {
        td.style.color = 'red';
      }

      if ( !value || value === '' ) {
        td.style.background = '#EEE';
      }

    }

    // グリッドのインスタンス生成
    grid = new Handsontable( container, {

      // バインドされる値
      data: data,

      // ヘッダー
      colHeaders: ['　日付　', '　開始　', '　終了　', '　休憩　', '　作業内容　'],

      // 行ごとの状態
      columns: [
        { readOnly: true },
        { type: 'dropdown', source: time_list() },
        { type: 'dropdown', source: time_list() },
        { type: 'dropdown', source: time_list() },
        {}
      ],

      // グリッドの更新後に実行されるやつ
      afterRender: function ( changes, source ) {
        platform_editor.setText();
      },

      // セルの大きさ変更禁止
      afterCreateRow: function(index, amount){
        data.splice(index, amount)
      },

      cells: function ( row, col, prop ) {

        var cellProperties = {};

        // マイナスイメージの設定
        cellProperties.renderer = negativeValueRenderer;

        return cellProperties;
      }

    });

  })();
</script>